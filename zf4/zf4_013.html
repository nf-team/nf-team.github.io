<HTML>
<HEAD>
<TITLE>
Фрагменты из эхи * Zemsky Fershal //NF (C) 1998-2004
</TITLE>
<STYLE TYPE="text/css">
BODY {font-family:Courier; font-size:10pt;}
PRE  {font-family:Courier; font-size:10pt;}
</STYLE>
</HEAD>
<BODY>
<P><CENTER><IMG SRC="ZF-2.gif" ALT="ZF"></CENTER></P>
<TABLE ALIGN="center">
<TR>
<TD>
<PRE>
                        Фрагменты из эхи

    1. Как правильно разобрать и вылечить файл, инфицированный
сразу несколькими вирусами?

F&gt;     Допустим, что файл инфицирован тремя  различными вирусами.
F&gt; Вирус1 (V1). Ищет сигнатуру &quot;0CD21h&quot; в первом килобайте жертвы
F&gt; и записывает туда переход на свое тело.  Тело  дописывается  в
F&gt; конец. После тела дописывается до килобайта случайных байт.

Q&gt;    Теорема без    доказательства:    если    это   &quot;корректно
Q&gt; работающий&quot; вирус,  то он восстановит  CD  21  хх  в  позицию,
Q&gt; которая   ссылается   на  начало  сигнатуры  sig1.  это  смысл
Q&gt; операции,  которую и нужно искать.  этим занимается эвристика.
Q&gt; по  большому счету,  надежнее всего писать лечилку для каждого
Q&gt; вируса отдельно.  попытки  обобщать  методы  лечения  приводят
Q&gt; именно к таким упорам, как здесь: &quot;а КАК его лечить?&quot; а почему
Q&gt; этот вирус должен лечиться с помощью  _простого_  сигнатурного
Q&gt; поиска?  давай напишем язык, который всунем в вирусную базу, и
Q&gt; пусть этот язык определяет начало сигнатуры.  поскольку вирус1
Q&gt; генерирует  случайный  массив байт,  то это неизлечимый вирус,
Q&gt; поскольку случайно может выйти сигнатура вируса2  (с некоторой
Q&gt; отличной  от  ноля  вероятностью  <FONT FACE="Wingdings">J</FONT>.  и  тогда  исцеление от
Q&gt; вируса2 произойдет некорректно.

F&gt;     Вирус2 (V2).  Записывает  переход  на  свое  тело в первых
F&gt; байтах жертвы.  Свое тело пишет в область одинаковых  байт  (в
F&gt; середину кода жертвы).

Q&gt;     Тут поиск начала сигнатуры довольно простой. то есть, даже
Q&gt; трассировать особенно не придется.

F&gt;     Вирус3 (V3).  Раскидывает свой код по всему  телу  жертвы.
F&gt; Переход  на первый свой блок вставляет в точку выхода из подп-
F&gt; рограммы (RETF).

Q&gt;    Поскольку RETF короче,  чем JMP куда-то, то вирус, который
Q&gt; можно исцелить,  должен восстанавливать эти байты.  если он их
Q&gt; не  восстанавливает,  то  он  их  может и не запоминать (как и
Q&gt; вирус1), и поэтому файл будет классифицирован как неизлечимый.
Q&gt; если  же  излечим в принципе,  то ищем переход на sig1.  а это
Q&gt; снова трассировщик (эмулятор) с эвристиком. ну, хотя, может, и
Q&gt; просто  сканирование  сигнатуры операции перехода.  но снова -
Q&gt; это не простой сигнатурный поиск.  хотя,  нужно  определиться,
Q&gt; насколько прост простой сигнатурный поиск <FONT FACE="Wingdings">J</FONT>

F&gt; Примеры:
F&gt; GOAT1.COM = GOAT.COM + V1 + V2 + V3
F&gt; GOAT2.COM = GOAT.COM + V2 + V1 + V3
F&gt; GOAT3.COM = GOAT.COM + V2 + V3 + V1
F&gt; GOAT4.COM = GOAT.COM + V3 + V2 + V1
F&gt; GOAT5.COM = GOAT.COM + V3 + V1 + V2
F&gt; GOAT6.COM = GOAT.COM + V1 + V3 + V2

Q&gt;    Проблема состоит только с вирусами, которые изменяют длину
Q&gt; файла. скажем, вирус2 проблемы не несет. потому что корректное
Q&gt; лечение   заключается  в  восстановлении  начальных  байт,  и,
Q&gt; возможно,  массива одинаковых байт  в  теле.  поэтому  лечение
Q&gt; должно  начинаться  с  таких вирусов.  утверждение,  кажущееся
Q&gt; умным:  корректировать  длину  файла  некорректно   до   конца
Q&gt; излечения. еще одна теорема без доказательства: если вирусы не
Q&gt; затрагивают  код  друг  друга,  то  файл  излечим  всегда.   в
Q&gt; противном  случае  -  если  последовательность запуска вирусов
Q&gt; выделить удается,  то лечим их в этой последовательности; если
Q&gt; не удается - то файл неизлечим.  важное следствие:  трассируем
Q&gt; файл,  пока не наткнемся на вирус.  это будет  либо  излечимый
Q&gt; случай1, когда вирусы не затрагивают друг друга, или это будет
Q&gt; излечимый  случай2,  когда  мы  отыскали  вирус  в  правильной
Q&gt; последовательности.  конечно,  нужно  придумать  еще  детектор
Q&gt; случая3, когда мы отыскали затрагивающие друг друга вирусы, но
Q&gt; начали  не  с  того.  чтобы  сигнализировать  о неизлечимости.
Q&gt; поскольку раз _мы_ дотрассировались до  неправильного  вируса,
Q&gt; то   и  процессор  может  до  него  добраться  именно  в  этой
Q&gt; последовательности,  и кто знает, может, это случается всегда.
Q&gt; вирус3  должен  куда-то  сохранить  байты  из-под  пятен.  это
Q&gt; обязательно произойдет в конец файла. если эти байты находятся
Q&gt; _после_ начала вирус1, значит, сначала был вирус1. если _до_ -
Q&gt; то вирус3.  хотя,  из важного  следствия  можно  сказать,  что
Q&gt; последнее предложение не важно.

</PRE>
</TD>
</TR>
</TABLE>
<HR>
<CENTER>(C) NF, 1998-2004</CENTER>
</BODY>
</HTML>
