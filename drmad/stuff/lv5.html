<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<title>Основы графического программирования в среде LabVIEW</title>
<style type="text/css">
   BODY {font-family:Arial; font-size:10pt; margin-left:10;margin-right:10} 
   TD {font-family:Arial; font-size:10pt}
   P {font-family:Arial; font-size:10pt; text-align:justify}
   LI {font-family:Arial; font-size:10pt}
   UL {font-family:Arial; font-size:10pt}   
   PRE {font-family:Tahoma; font-size:10pt}
   STRONG  {font-family:Arial; font-size:10pt}
   CENTER {font-family:Arial; font-size:10pt}
</style>	
</head>

<body>
<table align="center" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr>
    <td width="15%" height="25" bgcolor="teal"></td>
    <td width="70%" height="25" bgcolor="teal"></td>
    <td width="15%" height="25" bgcolor="teal"></td>
</tr>
<tr>
    <td width="15%" height="50"></td>
    <td width="70%" height="50" align="center"><b><font face="arial black" size="+4" color="Teal">DRMADСКОЕ БАРАХЛО</font></b></td>
    <td width="15%" height="50"></td>
</tr>
<tr>
    <td width="15%" height="25" bgcolor="teal"></td>
    <td width="70%" height="25" bgcolor="teal"></td>
    <td width="15%" height="25" bgcolor="teal"></td>
</tr>
<tr>
    <td width="15%" height="25" bgcolor="#60C0C0"></td>
    <td width="70%" height="25" bgcolor="#60C0C0"></td>
    <td width="15%" height="25" bgcolor="#60C0C0"></td>
</tr>
<tr>
    <td width="15%" height="100%" bgcolor="#60C0C0"></td>
    <td width="70%" height="100%">
	
    <table border="0" bordercolor="teal" width="100%" height="100%" cellpadding="10">
    <tr>
    <td>
	
    <!---> 	

<TABLE ALIGN=CENTER CELLPADDING=0 BGCOLOR="Teal" WIDTH="100%">
<TR>
<TH>
 <FONT SIZE=+1 COLOR="White">  
Климентьев К.Е. <br>
Основы графического программирования
в среде LabVIEW. Фрагмент 5<br>
</FONT>
</TH>
</TR>
</TABLE>

<br><a href="lv0.html"><img src="back.gif"></a><br>

<h1><a name="m0">6. Пример использования LabVIEW</a></h1>

<p>
Ряд типичных приемов, используемых при программировании на LabVIEW задач реального времени, проиллюстрируем на конкретном примере.
</p>

<p>
<div align="center">
<table width="80%"><tr><td>
<b>Требуется осуществить  цифровую регистрацию с частотой 5 кГц случайного процесса, представляющего собой динамически изменяющееся в диапазоне 0-2В напряжение. В качестве средства измерения использовать звуковую карту.
</b></td></tr></table>
</div>
</p>

<p>
Встроенный таймер LabVIEW имеет разрешение 1 мс, что позволяет организовывать сбор данных только с частотой порядка 1 кГц. Поэтому для решения задачи целесообразно использование возможностей, предоставляемых аппаратным таймером ПЭВМ.
</p>

<h2><a name="m1">6.1.  Устройство и программирование звуковой карты</a></h2>

<p>
Современные звуковые карты представляют собой сложные многофункциональные устройства, содержащие высокоточные (разрядность 16-24 бита) быстродействующие (время преобразования 5-25 мкс) АЦП и ЦАП (см. рисунок 6.1).
</p>
	 
<p>
<div align="center">
<img src="lv6_1.gif" border=0 alt="">
<br>Рисунок 6.1.<br> 
Функциональная схема звуковой карты
</div>
</p>

<p>
На этом рисунке: "LINE IN" - линейный вход, "MIC" - вход с микрофона, "LINE OUT" - линейный выход, "SPKR" - выход на наушники или внешние динамики, "Ф" - аналоговые фильтры, "У" - усилители аналоговых сигналов, "DSP" - процессор звуковых сигналов. На DSP возложено большое количество задач по управлению процессами аналогово-цифрового и цифро-аналогового преобразования, по синтезу и обработке звуковых сигналов, по обмену данными с ПЭВМ и пр. В частности, DSP поддерживает ряд сохранившихся еще с младших моделей Creative Soundblaster режимов работы звуковой карты, предусматривающих непосредственный 8-битовый одноканальный ввод-вывод.
</p>

<p>
Программное управление режимами работы DSP осуществляется через порты ввода-вывода (см. таблицу 6.1) при помощи специальных команд (см. таблицу 6.2). По умолчанию базовый адрес области портов ввода-вывода звуковой карты BASE=220h (хотя встречаются значения 230h, 240h и т.п.).
</p>

<p align="right">Таблица 6.1</p>
<div align="center">Некоторые порты ввода-вывода звуковой карты</div>
<p>
<center>
<table border="2" width="90%">
<tr> <td>Адрес порта</td>	<td>Назначение</td></tr>
<tr> <td>BASE+6</td>	    <td>Регистр управления DSP</td></tr>
<tr> <td>BASE+0Ah</td>	<td>Буферный регистр для чтения данных</td> </tr>
<tr> <td>BASE+0Ch</td>
<td>
1. Буферный регистр для  записи данных и команд<br>
2. Регистр состояния буфера записи (если бит 7 сброшен, то разрешена запись в буферный регистр)
</td>
</tr>
<tr>
<td>BASE+0Eh</td>
<td>Регистр состояния буфера чтения (если бит 7 установлен, то разрешено чтение из буферного регистра)
</td>
</tr>
</table>
</center>
</p>


<p align="right">Таблица 6.2</p>
<div align="center">Некоторые  команды управления DSP</div>
<p>
<center>
<table border="2" width="90%">
<tr><td>Команда</td>	<td>Описание</td></tr>
<tr><td>10h</td>	    <td>Передача байта на ЦАП</td></tr>
<tr><td>20h</td>	    <td>Чтение байта с АЦП</td></tr>
<tr><td>0D1h</td>	<td>Разрешить ввод-вывод</td></tr>
<tr><td>0D3h</td>	<td>Запретить ввод-вывод</td></tr>
</table>
</center>
</p>
<p>
	Инициализация DSP состоит из следующих действий (см. рис. 6.2):
	<ul>
<li>послать значение 1 в порт BASE+6;
<li>выполнить временную задержку;
<li>послать значение 0 в порт BASE+6. 
</ul>
</p>
 	 

<div align="center">
<img src="lv6_2.gif" border=0 alt="">
<br> Рисунок 6.2. <br>
СубВП инициализации DSP
</div>
<p>
	Чтение из DSP (см. рисунок 6.3) заключается в том, чтобы:
<ul>	
<li>в цикле ожидать готовности DSP (установки 7-го бита в порту BASE + 0Eh);
<li>прочитать байт из порта BASE+0Ah.
</ul></p>
 	 

<div align="center">
<img src="lv6_3.gif" border=0 alt="">
<br>Рисунок 6.3.<br> 
СубВП чтения из DSP
</div>

<p>	
Аналогично выглядит запись в DSP (см. рисунок 6.4):
<ul>
<li>в цикле ожидать готовности  DSP (сброса 7-го бита в порту BASE +0Ch);
<li>записать байт в порт BASE+0Ch.
</ul>
</p>

<div align="center">
<img src="lv6_4.gif" border=0 alt="">
<br>Рисунок 6.4.<br> 
СубВП записи в DSP
</div>
<p>
Разрешение ввода-вывода заключается в  посылке в DSP команды 0D1h, а запрещение ввода-вывода - в посылке команды 0D3h.
</p>
<p>
	Чтение данных из АЦП звуковой карты складывается из следующих действий:
<ul><li>послать в DSP команду с кодом 20h;
<li>прочитать байт данных из DSP.</ul>
</p>
<p>
В противоположность этому, посылка данных на ЦАП звуковой карты заключается в том, чтобы:
<ul><li>послать в DSP команду с кодом 10h;
<li>послать в DSP байт данных.</ul>
</p>

<h2><a name="m2">6.2.  Системный таймер ПЭВМ</a></h2>

<p>	Системный таймер современных ПЭВМ - это устройство, позволяющее вычислительной системе решать задачи реального времени, а именно:
<ul><li>измерять моменты наступления программно-аппаратных событий;
<li>самостоятельно генерировать такие события в требуемые моменты времени.</ul></p>
<p>
Функционально системный таймер может быть представлен в виде совокупности трех "каналов", работающих независимо друг от друга (см. рисунок 6.5). Работа каждого из каналов синхронизирована с тактовыми импульсами, поступающими с кварцевого генератора с частотой 1,193 МГц. 
</p>
<p>	<div align="center"> 
<img src="lv6_5.gif" border=0 alt="">
<br>Рисунок 6.5. <br>
Функциональная схема системного таймера
</div></p>
<p>
Каждый из каналов может работать в одном из шести режимов. По умолчанию для всех каналов установлен режим №3. В этом режиме каналы работают следующим образом (см. рисунок 6.6):
</p>
<ul>
<li>в счетчик таймера загружается некоторая константа пересчета в диапазоне 1..65535 (по умолчанию она имеет максимально возможное значение);
<li>по фронту каждого приходящего тактового импульса из счетчика вычитается двойка;
<li>при достижении счетчиком значения 0 на выходе у канала таймера инвертируется значение сигнала "OUT", кроме того в счетчик вновь загружается исходная константа и работа счетчика продолжается;
<li>по фронту сигнала "OUT" (т.е. при каждом втором обнулении счетчика) генерируется некоторое "событие".
</ul>
	 
<p><div align="center">
<img src="lv6_6.gif" border=0 alt="">
<br>Рисунок 6.6.<br> 
Работа каналов таймера в режиме №3
</div></p>
<p>
"События" канала 0 заключаются в том, что на контроллер прерываний подаются запросы с приоритетом Irq0 и, соответственно, в системе возникают прерывания с номером 8. Прерывание 8 используется операционной системой Windows для организации вытесняющей многозадачности.
</p>
<p>"События" канала 1 заключаются в генерации тактовых импульсов, синхронизирующих системные процессы на материнской плате ПЭВМ.
</p>
<p>"События" канала 2 представляют собой прямоугольные импульсы, подающиеся на вход встроенного компьютерного динамика. Управление работой канала и звучанием динамика осуществляется через порт 61h: бит 0 маскирует поступление в счетчик канала тактовой частоты, а бит 1 - маскирует передачу выходного сигнала канала на динамик.
</p>
<p>	Все три канала являются программируемыми: возможно переключение режимов работы канала, изменение константы пересчета, считывание и загрузка значений счетчиков и пр. Управление таймером осуществляется через порт 43h (см. таблицу 6.3).
</p>
<p>

<p align="right">Таблица 6.3</p>
<div align="center">Управляющий регистр системного таймера</div>
<center>
<table width="80%" border="2">
<tr><td>Биты</td>	<td>Назначение</td></tr>
<tr><td>0</td>	    <td>Тип счета: 0 - двоичный , 1- двоично-десятичный</td> </tr>
<tr><td>1..2</td>	<td>Режим работы канала: 011 - режим №3.</td></tr>
<tr><td>4..5</td>	
<td>Команда: 00 - зафиксировать значение счетчика в буферном регистре; 01 - подготовить чтение/загрузку старшего байта счетчика; 10 - подготовить чтение/загрузку младшего байта счетчика; 11 - подготовить последовательное чтение/загрузку младшего и старшего байтов счетчика.</td></tr>
<tr><td>6..7</td><td>Номер канала: 00 - нулевой, 01-первый, 10-второй.</td></tr> 
</table>
</center>
<p>
Обмен данными с каналами счетчика выполняется через порты 40h (нулевой канал), 41h (первый канал), 42h (второй канал).
</p>
<p>
Идея реализации сбора данных в режиме реального времени заключается в том, чтобы запрограммировать канал №2 таймера на работу с требуемой частой, сканировать в цикле значения счетчика и выполнять опрос АЦП в момент его (счетчика) перезагрузки.
</p>
<p>
Инициализация счетчика заключается в следующем (см. рисунок 6.7):
<ul>
<li>записать в порт 43h управляющее слово со значением 0B6h;
<li>последовательно записать в буферный регистр 42h младший и старший байты константы пересчета, соответствующей требуемой частоте  опроса (0.0002с*1193180*2 1/c = 478);
<li>запустить счет (с одновременным отключением динамика) записью в порт 61h значения 1.
</ul>
</p>

<div align="center"> 	 
<img src="lv6_7.gif" border=0 alt="">
<br>Рисунок 6.7.<br> 
СубВП инициализации второго таймерного канала
</div>
<p>
	Чтение текущего значения счетчика второго канала таймера можно выполнить так:
<ul>	
<li>подготовить чтение, послав в порт 43h управляющий байт со значением 86h;
<li>последовательно прочитать из буферного порта 42h сначала младший, а затем старший байты значения счетчика. 
</ul>
</p>
 	 
<div align="center">
<img src="lv6_8.gif" border=0 alt="">
<br>Рисунок 6.8.<br> 
СубВП чтения счетчика второго таймерного канала
</div>

<h2><a name="m3">6.3.  Работа с ВП сбора данных</a></h2>
<p>
Используя разработанные ранее и описанные выше субВП, можно скомпоновать ВП сбора аналоговых данных с использованием звуковой карты (см. рисунки 6.9-6.11).
</p>

<div align="center">
<img src="lv6_9.gif" border=0 alt="">
<br>Рисунок 6.9.<br> 
Лицевая панель ВП
</div>

<div align="center">
<img src="lv6_10.gif" border=0 alt="">
<br>Рисунок 6.10.<br> 
Блок-схема ВП
</div>

<div align="center">
<img src="lv6_11.gif" border=0 alt="">
<br>Рисунок 6.11.<br> 
Блок-схема ВП (скрытые фреймы)
</div>

<p>	

<i>Примечание. Лицевые панели большинства СубВП, использованных при построении демонстрационного ВП, имеют тривиальный вид, и поэтому на рисунках не отображены.</i>

</p>
<p>
Правила работы с этим ВП следующие.
</p>
<p>
Шаг 1. Подключите на вход звуковой карты источник аналогового сигнала (например, микрофон). Также для проверки результатов работы подключите к выходу звуковой карты наушники или динамик.
</p>
<p>
Шаг 2. Загрузите ВП. Убедитесь, что на вход звуковой карты поступает информативный сигнал и запустите ВП. Через некоторое время, после заполнения буфера данными, на табло появится график оцифрованного сигнала, а в динамике прозвучит "эхо".
</p>
<p>
<i>Примечание. На входе звуковых карт ставятся фильтры нижних частот, поэтому использование их АЦП целесообразно только для измерения сигналов с частотами выше 20 Гц.
</i>
</p>

<hr>
(с) Constantin E. Climentieff aka DrMad,
<a href="mailto:drmad@dr.com"> mailto: drmad@dr.com</a> * <a href="http://www.chat.ru/~drmad">http://www.chat.ru/~drmad</a>
<hr>


    </td>
    </tr>
    </table>
    </td>

    <td width="15%" height="100%" bgcolor="#60C0C0"></td>
</tr>
</table>

</body>
</html>

